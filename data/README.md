# Data package
This package is for preparing and handling data used in the `mlreco_cell` repository. Specifically it works and interfaces with the DUNE LarSoft framework, `dunetpc`. 

The following scripts need to run in an environment where it is available (e.g. on Cori can use `shifter --module=cvmfs --image=ethlu/sl7_dune:a` as a prefix). Note the Slurm batch scripts do that automatically.

## File convention and management: *util.py*

- The filename for any data file used throughout this repository should match `FILE_REGEX` at the top: it has to contain an "event type" found in `EVENT_TYPES`, followed by an "index", followed by a "product type" found in `PRODUCT_TYPES`. There should be a spacer in between each attribute, usually an underscore.

	E.g. *reco\_BeamCosmic\_001.root* is a simulation file generated by LarSoft that has event type "BeamCosmic", index 1, product type "root"

- Derived data files should preserve as much as possible the original name, usually only the product type is modified and, if needed, additional info is added.

	E.g. If we were to extract the wire readout from this simulation file using the parser (see below), then the resulting file would be something like *reco\_BeamCosmic\_001_wire.npz*.

	Actually since we usually process TPCs separately, the parsers generally add the TPC information. E.g. *reco\_BeamCosmic\_001_wire-TPC1.npz* if we are only looking at TPC 1.

## Generating simulation data: *mc_scripts/*
This directory contains a set of bash scripts that produce the simulation ROOT files for different event types. A set of fcl scripts needed to run the simulation are also included in *mc_scripts/larjob/* 

E.g. To generate a single BeamCosmic file: `mc_scripts/gen_fullchain_BeamCosmic.sh` 

Note: may need to modify BASEDIR in the script to change the output location and modify the absolute path that points to *larjob/*. 

To run a batch on Cori use `sbatch mc_scripts/submit_BeamCosmic.sh`

## Data interfacing: *io/*
*parse_art.py* is the main script to extract information from the LarSoft ROOT files. At the bottom of the file inside the "main" clause, different parsers (e.g. `proc_wire`) are created using factory functions (where information like which TPC and the output product type suffix are specified as arguments). Then they are pushed onto the global variables `product_dict` or `evt_procs` depending on their type. The former is used when the parser accesses a single product from the ROOT file (e.g. `recob::Wire`), and the latter is generally for more complex parsers. 

Note: change the TPC_NUM to access different TPCs.

Note: `proc_spacepoint` has a different geometry due to the fact that "SpacePointSolver" merges the two TPCs along the drift direction. It therefore contains at least 2 TPCs, e.g. "TPC12". The corresponding MC truth information (e.g. "depoElectron" for electron deposition) can be constructed by first parsing the TPCs, e.g. 1 and 2, seperately and then run `python3 io/util.py parsed_dir` to join them.
	
Note: the commented out parsers are potentially also interesting.

* To run: `scripts/parse_art.sh -i input_dir -o out_dir`

	Note: the actual output "parsed" directory is *BASE_DIR/out\_dir* where BASEDIR is a variable in *scripts/parse_art.sh* currently set to *SCRATCH/larsim*.

	Note: (Optional) one can filter out files by tweaking the `art_fd` variable in the main function `process_multi`. An example is commented out where we choose only file indices 301 and 302.

